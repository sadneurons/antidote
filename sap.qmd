---
title: "AnTIDOTe RCT \n statistical analysis plan"
subtitle: "Draft v0.1"
author: "Ross Dunne"
format: 
  html:
    toc: true
    toc-depth: 3
    toc-title: "Contents"
    toc-location: left
    page-layout: article
editor: source
reference-location: margin
citation-location: margin
body-footer: "Copyright (c) 2022"
---

## Part I: Sample size calculations for a randomised controlled trial in delirium {.unnumbered .unlisted}

## Project Title: ANakinra for the Treatment of Inflammation and Delirium after Orthopaedic Trauma and rEpair (ANTIDOTE) -- Randomised Controlled Trial. {.unnumbered .unlisted}

## PICOT

**(P)** -- Patients presenting to Emergency Departments in South Manchester with radiologically confirmed hip fracture who are aged 65 and over and have none of the following exclusion criteria: 1) Lack of a study partner or caregiver 2) Active infection 3) History of hypersensitivity to or unacceptable side effects of Anakinra 4) Current substance misuse 5) Active malignancy 6) Acute stroke or TIA 7) Currently participating in clinical trial of an investigational medicinal product (CTIMP) 8) Women of child-bearing potential 9) Neutropenia of any cause.

**(I)** -- Anakinra given subcutaneously at time 0 \[presentation to ED\] then bd for 48 hours during the perioperative period.

**(C)** -- Normal saline given subcutaneously at time 0 \[presentation to ED\] then bd for 48 hours during the perioperative period.

**(O)** -- 1°) Severity of delirium postoperatively as measured by the XXXXXXXX 2) (2°) Time to first weight bearing postoperatively 3) (3°) Time until medically fit for discharge postoperatively 4) (3°) Safety of Anakinra during the perioperative period and in wound healing 5) (3°) Tolerability of Anakinra versus placebo in terms of common side effects 6) (3°) Effect of Anakinra on 30-day mortality

**(T)** -- Recruitment period: 24 months; Treatment/assessment period: to 48hrs postop, measured from surgical wound closure.

## Frequentist simulation

**Assumption:**: Delirium rating scales are ordinal measures, not interval measures (a person scoring 4 is not half as delirious as someone scoring 8)

**Solution**: Ordinal logistic regression does not assume interval scales, nor normal distributions of the scores. It does make a proportional-odds assumption testable using the parallel test. The coefficients can be interpreted as the log-odds of a one point increase in the scale score, $y$, with a one point (or one unit) increase in the predictor variable $x$.

**Assumption**: While delirium is by its nature a fluctuating condition, we assume there will be correlation within participants in delirium scale scores over time.

**Solution**: Mixed effects models will allow for an autoregressive correlation structure and regularisation of the model. Frequentist ordinal logistic mixed models are facilitated by R packages 'ordinal' and 'rms' and Bayesian mixed effects ordinal regression models are facilitated by packages 'brms' (with cumulative log-odds link function) and 'rmsb'. These have been used in simulation below.

**Assumption**: There may be significant anaesthetic methods (spinal/GA) in those presenting to the ED with hip fractures. The descriptive statistics for Wythenshawe hospital can be found below.

**Solution** Because the nature of the anaesthetic (spinal versus general) may relate to the nature of the participants' comorbidities and the presence or absence of preoperative delirium, we will use a minimisation strategy to ensure equal numbers of spinal and general anaesthetic procedures in each trial arm. The numbers of participants having GA will vary month-month.

```{r echo=FALSE, results='hide', message=FALSE}
#| column: screen-inset-shaded
#| layout-nrow: 1
library(readr)
library(tidyverse)
library(rms)
wyhipsurg <- read_csv("NHFD-WYT-ANA02-04072022173127.csv")
wyhipsurg |> ggplot() + geom_histogram(aes(x=`General anaesthetic %`)) + ggtitle("Histogram of percentage of GA per month at Wythenshawe Hospital") + labs(subtitle="Source: NHF Database https://www.nhfd.co.uk/")
wyhipsurg$surgdate <- wyhipsurg$`Admission Year & Month`
wyhipsurg$surgdate <- lubridate::my(wyhipsurg$surgdate)
wyhipsurg |> ggplot() + geom_line(aes(y=`General anaesthetic %`, x=surgdate)) + geom_smooth(aes(y=`General anaesthetic %`, x=surgdate)) + ggtitle("Trend of percentage of GA per month (Loess) at Wythenshawe Hospital") + xlab("Month and year of surgery") + labs(subtitle="Source: NHF Database https://www.nhfd.co.uk/")
wyhipsurg$days <- as.numeric(wyhipsurg$surgdate)-min(as.numeric(wyhipsurg$surgdate))
gas_method_mdl<- rms::ols(`General anaesthetic %`~ rcs(days, 3) , data=wyhipsurg)
pred_method <-  fitted(gas_method_mdl)
wyhipsurg |> ggplot() + geom_line(aes(y=`General anaesthetic %`, x=surgdate)) + geom_smooth(aes(y=`General anaesthetic %`, x=surgdate)) + ggtitle("Prediction model of percentage of GA per month (rcs) at Wythenshawe Hospital") + xlab("Month and year of surgery") + geom_line(aes(y=pred_method, x=wyhipsurg$surgdate), lwd=2, lty=2) + labs(subtitle="Source: NHF Database https://www.nhfd.co.uk/")
sd(gas_method_mdl$residuals)
```
```{r echo=FALSE}
library(downloadthis)

wyhipsurg %>%
  download_this(
    output_name = "Wythenshawe_Hip_Surgery_Anaesthesia",
    output_extension = ".rds",
    button_label = "Download R data object (.rds)",
    button_type = "default",
    has_icon = TRUE,
    icon = "fa fa-save"
  )
```

This can be modelled using a restricted cubic spline function with $k = 3$ knots, in order to estimate the month to month variation (rather than including the variation over years). However, it is also clear that we would expect the percentage of participants receiving general anaesthetics to decrease over the 24-month duration of the trial if it started now.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
(gas_method_mdl)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
#| column: screen-inset-shaded
#| layout-nrow: 1
hist(gas_method_mdl$residuals, main="Histogram of anaesthetic method model residuals", xlab="Residual")
start_perc <- as.numeric(pred_method[length(pred_method)])
newdays <- seq(from=4048, to= 4048 + (365*2), by=30)
trial_predict_gasmethod <- predict(gas_method_mdl, newdata=newdays, se.fit=TRUE)
tpg <- cbind(trial_predict_gasmethod$linear.predictors, lubridate::as_date(newdays + 15065)) |> data.frame() 
names(tpg) <- c("Predicted", "Date")
tpg$upr<- trial_predict_gasmethod$linear.predictors + trial_predict_gasmethod$se.fit
tpg$lr<- trial_predict_gasmethod$linear.predictors - trial_predict_gasmethod$se.fit
tpg |> ggplot() + 
  geom_line(aes(y=Predicted, x=lubridate::as_date(Date))) + ggtitle("Predicted linear change during trial") + xlab("Month and year of surgery") + geom_line(aes(y=upr, x=lubridate::as_date(Date)), lty=2) + geom_line(aes(y=lr, x=lubridate::as_date(Date)), lty=2)

```

We thus have a predicted trial starting percentage of GA cases of `r start_perc |> round(2)`% and a month-month variation (sd of residuals of ols model using restricted cubic spline) of `r sd(gas_method_mdl$residuals) |> round(2)`%.

**Assumption**: There may be significant variation in time to operation in those presenting to the ED with hip fractures. Time-to-operation is a KPI in the National Hip Fracture Database and the descriptive statistics for Wythenshawe hospital can be found below.

**Solution**:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
#| column: screen-inset-shaded
#| layout-nrow: 1
bp <- read_csv("NHFD-WYT-BPT4-04072022185309.csv")
#names(bp)
bp$disdate <- bp$`Trust Discharge Year & Month`
bp$disdate <- lubridate::my(bp$disdate)
bp$days <- as.numeric(bp$disdate)
bp |> ggplot() + geom_histogram(aes(x=`Prompt surgery %`), binwidth=4) + ggtitle("Histogram of percentage of people operated on by 24h after admission") + labs(subtitle="Source: NHF Database https://www.nhfd.co.uk/")
bp |> ggplot() + geom_line(aes(y=`Prompt surgery %`, x=disdate)) +
  geom_smooth(aes(y=`Prompt surgery %`, x=disdate)) + ggtitle("Percentage of people operated on by 24h after admission") + xlab("Month and year of surgery") + labs(subtitle="Source: NHF Database https://www.nhfd.co.uk/")
surg_delay_mdl<- rms::ols(`Prompt surgery %`~ rcs(days, 4) , data=bp)
bp$pred_delay <- predict(surg_delay_mdl)
bp |> ggplot() + geom_line(aes(y=`Prompt surgery %`, x=disdate)) +
  geom_smooth(aes(y=`Prompt surgery %`, x=disdate)) + geom_line(aes(y=pred_delay, x=disdate), lwd=2, lty=2) + ggtitle("Prediction model of percentage of people operated on by 24h after admission") + xlab("Month and year of surgery") + labs(subtitle="Source: NHF Database https://www.nhfd.co.uk/")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
bp %>% download_this(   output_name = "Wythenshawe_Hip_Surgery_Best_Practice",
    output_extension = ".rds",
    button_label = "Download R data object (.rds)",
    button_type = "default",
    has_icon = TRUE,
    icon = "fa fa-save"
  )
```

### OSLA scale

![OSLA](Delirium-assessment-tool-OSLA.png){fig-align="center"} The OSLA scale is a 4-item scale with a minimum score of 0 and a maximum score of 15. Items respectively have a range of :

| Item        | Min | Max |
|-------------|-----|-----|
| Eye opening | 0   | 5   |
| Eye contact | 0   | 3   |
| Posture     | 0   | 3   |
| Movement    | 0   | 4   |

: OSLA Items

```{r, echo=TRUE, warning=FALSE, message=FALSE}
#| column: screen-inset-shaded
#| layout-nrow: 1
OSLA <- function(severity="None", return_format = "df"){
  # generate an OSLA score vector depending on severity
  # return as dataframe if return_format = df
  # return as vector if return_format = vector
  # return as integer sum if return_format = sum

  if (severity == "Severe"){
    probability <- 0.85
  }
  else if (severity == "Moderate"){
    probability <- 0.5
  }
  else if (severity == "Mild"){
    probability <- 0.3
  }
  else if (severity == "None"){
    probability <- 0.05
  }
  EO <- rbinom(1, 5, prob=probability) # eye opening
  EC <- rbinom(1, 3, prob=probability) # eye contact
  P <- rbinom(1, 3, prob=probability) # posture
  M <- rbinom(1, 4, prob=probability) # movement
  if(return_format == "df"){
    returned_df <- data.frame(cbind(EO, EC, P, M))
    return(returned_df)
  }
  else if(return_format == "vector"){
    returned_vec <- c(EO, EC, P, M)
    return(returned_vec)
  }
  else if(return_format == "sum"){
    returned_sum <- sum(EO, EC, P, M)
    return(returned_sum)
  }
  else {
    print("Unknown value for returned_format")
    return(NULL)
  }
  }

# make a **population** of mixed severity N= 100,000
# at baseline from which to sample

severe_pop <- replicate(10000, OSLA("Severe", "sum"))
moderate_pop <- replicate(15000, OSLA("Moderate", "sum"))
mild_pop <- replicate(15000, OSLA("Mild", "sum"))
none_pop <- replicate(60000, OSLA("None", "sum"))
total_pop_1 <- c(severe_pop, moderate_pop, mild_pop, none_pop)
total_pop_1 |>hist(main="Histogram I of OSLA scores (zero inflated)", xlab="OSLA score")


severe_pop <- replicate(60000, OSLA("Severe", "sum"))
moderate_pop <- replicate(15000, OSLA("Moderate", "sum"))
mild_pop <- replicate(15000, OSLA("Mild", "sum"))
none_pop <- replicate(10000, OSLA("None", "sum"))
total_pop_2 <- c(severe_pop, moderate_pop, mild_pop, none_pop)
total_pop_2|>hist(main="Histogram II of OSLA scores (severe)", xlab="OSLA score")

severe_pop <- replicate(30000, OSLA("Severe", "sum"))
moderate_pop <- replicate(25000, OSLA("Moderate", "sum"))
mild_pop <- replicate(30000, OSLA("Mild", "sum"))
none_pop <- replicate(15000, OSLA("None", "sum"))
total_pop_3 <- c(severe_pop, moderate_pop, mild_pop, none_pop)
total_pop_3 |>hist(main="Histogram III of OSLA scores (mild/severe)", xlab="OSLA score")

severe_pop <- replicate(10000, OSLA("Severe", "sum"))
moderate_pop <- replicate(60000, OSLA("Moderate", "sum"))
mild_pop <- replicate(20000, OSLA("Mild", "sum"))
none_pop <- replicate(10000, OSLA("None", "sum"))
total_pop_4 <- c(severe_pop, moderate_pop, mild_pop, none_pop)
total_pop_4 |>hist(main="Histogram IV of OSLA scores (moderate)", xlab="OSLA score")

```
